<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pop Dino - Country Battle</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .logo {
            font-size: 2rem;
            font-weight: bold;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .country-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 16px;
            border-radius: 20px;
            color: #333;
            font-weight: bold;
        }

        .country-flag {
            font-size: 1.5rem;
        }

        .main-container {
            flex: 1;
            display: flex;
            padding: 20px;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .game-area {
            flex: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .country-score {
            text-align: center;
            margin-bottom: 20px;
            color: #fff;
        }

        .country-name {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .score-display {
            font-size: 3rem;
            font-weight: bold;
            color: #fff;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 255, 255, 0.2); }
            to { text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3), 0 0 30px rgba(255, 255, 255, 0.4); }
        }

        .dino-container {
            position: relative;
            cursor: pointer;
            transition: transform 0.1s ease;
        }

        .dino-container:hover {
            transform: scale(1.05);
        }

        .dino-container:active {
            transform: scale(0.95);
        }

        .dino {
            width: 300px;
            height: 300px;
            border-radius: 20px;
            background: linear-gradient(145deg, #4CAF50, #45a049);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease;
            user-select: none;
        }

        .dino.clicked {
            transform: scale(0.9);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        }

        .click-effect {
            position: absolute;
            pointer-events: none;
            font-size: 2rem;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            animation: floatUp 1s ease-out forwards;
        }

        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-100px) scale(1.5);
            }
        }

        .stats {
            margin-top: 30px;
            text-align: center;
            color: #fff;
        }

        .stat-item {
            margin: 10px 0;
            font-size: 1.2rem;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .battle-info {
            background: rgba(255, 215, 0, 0.2);
            border: 2px solid rgba(255, 215, 0, 0.5);
            border-radius: 15px;
            padding: 15px;
            margin-top: 20px;
            text-align: center;
            color: #fff;
        }

        .battle-info h3 {
            margin-bottom: 10px;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .leaderboard {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            max-height: 80vh;
            overflow-y: auto;
        }

        .leaderboard h2 {
            color: #fff;
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .leaderboard-item {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.2s ease;
        }

        .leaderboard-item:hover {
            transform: translateX(5px);
        }

        .leaderboard-item.current-country {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            font-weight: bold;
        }

        .rank {
            font-size: 1.5rem;
            font-weight: bold;
            color: #666;
            min-width: 40px;
        }

        .rank.first { color: #FFD700; }
        .rank.second { color: #C0C0C0; }
        .rank.third { color: #CD7F32; }

        .country-info-item {
            flex: 1;
            margin-left: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .country-flag-small {
            font-size: 1.2rem;
        }

        .country-name-small {
            font-weight: bold;
            color: #333;
        }

        .country-score-small {
            font-size: 1.2rem;
            font-weight: bold;
            color: #4CAF50;
        }

        .loading {
            text-align: center;
            color: #fff;
            font-size: 1.2rem;
            padding: 20px;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid rgba(255, 0, 0, 0.3);
            color: #fff;
            padding: 10px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            z-index: 1000;
        }

        .connection-status.online {
            background: rgba(76, 175, 80, 0.9);
            color: white;
        }

        .connection-status.offline {
            background: rgba(244, 67, 54, 0.9);
            color: white;
        }

        .reset-notice {
            background: rgba(255, 255, 0, 0.1);
            border: 2px solid rgba(255, 255, 0, 0.3);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 20px;
            text-align: center;
            color: #fff;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                padding: 10px;
            }
            
            .dino {
                width: 250px;
                height: 250px;
                font-size: 6rem;
            }
            
            .score-display {
                font-size: 2rem;
            }
            
            .logo {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">üîÑ Connecting...</div>
    
    <div class="header">
        <div class="logo">ü¶ï Pop Dino - Global Battle</div>
        <div class="country-info" id="countryInfo">
            <div class="country-flag" id="countryFlag">üåç</div>
            <div id="countryName">Detecting...</div>
        </div>
    </div>

    <div class="main-container">
        <div class="game-area">
            <div class="reset-notice">
                üöÄ Fresh Start! All countries begin at 0 points. May the best nation win!
            </div>
            <div class="country-score">
                <div class="country-name" id="gameCountryName">Your Country</div>
                <div class="score-display" id="scoreDisplay">0</div>
            </div>
            <div class="dino-container" id="dinoContainer">
                <div class="dino" id="dino">ü¶ï</div>
            </div>
            <div class="stats">
                <div class="stat-item">Clicks per second: <span id="cps">0</span></div>
                <div class="stat-item">Your contribution: <span id="personalClicks">0</span></div>
                <div class="stat-item">Total country clicks: <span id="countryClicks">0</span></div>
            </div>
            <div class="battle-info">
                <h3>üåç Global Competition</h3>
                <p>Help your country dominate the world leaderboard!</p>
                <p>Every click counts towards your nation's glory!</p>
                <p><strong>Fair competition - all countries start at 0!</strong></p>
            </div>
        </div>

        <div class="leaderboard">
            <h2>üèÜ World Leaderboard</h2>
            <div id="leaderboardList">
                <div class="loading">
                    <div class="spinner"></div>
                    <div>Loading global battle...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Country data with flags
        const countryData = {
            'TH': { name: 'Thailand', flag: 'üáπüá≠' },
            'US': { name: 'United States', flag: 'üá∫üá∏' },
            'GB': { name: 'United Kingdom', flag: 'üá¨üáß' },
            'JP': { name: 'Japan', flag: 'üáØüáµ' },
            'KR': { name: 'South Korea', flag: 'üá∞üá∑' },
            'CN': { name: 'China', flag: 'üá®üá≥' },
            'DE': { name: 'Germany', flag: 'üá©üá™' },
            'FR': { name: 'France', flag: 'üá´üá∑' },
            'IT': { name: 'Italy', flag: 'üáÆüáπ' },
            'ES': { name: 'Spain', flag: 'üá™üá∏' },
            'BR': { name: 'Brazil', flag: 'üáßüá∑' },
            'CA': { name: 'Canada', flag: 'üá®üá¶' },
            'AU': { name: 'Australia', flag: 'üá¶üá∫' },
            'IN': { name: 'India', flag: 'üáÆüá≥' },
            'RU': { name: 'Russia', flag: 'üá∑üá∫' },
            'MX': { name: 'Mexico', flag: 'üá≤üáΩ' },
            'AR': { name: 'Argentina', flag: 'üá¶üá∑' },
            'NL': { name: 'Netherlands', flag: 'üá≥üá±' },
            'SE': { name: 'Sweden', flag: 'üá∏üá™' },
            'NO': { name: 'Norway', flag: 'üá≥üá¥' },
            'XX': { name: 'Unknown', flag: 'üåç' }
        };

        // Game State
        let gameState = {
            personalClicks: 0,
            countryClicks: 0,
            clickTimes: [],
            userCountry: 'XX',
            isOnline: false,
            leaderboard: {},
            sessionId: generateSessionId()
        };

        // Generate unique session ID
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // DOM Elements
        const scoreDisplay = document.getElementById('scoreDisplay');
        const dinoContainer = document.getElementById('dinoContainer');
        const dino = document.getElementById('dino');
        const personalClicksDisplay = document.getElementById('personalClicks');
        const countryClicksDisplay = document.getElementById('countryClicks');
        const cpsDisplay = document.getElementById('cps');
        const leaderboardList = document.getElementById('leaderboardList');
        const countryInfo = document.getElementById('countryInfo');
        const countryFlag = document.getElementById('countryFlag');
        const countryName = document.getElementById('countryName');
        const gameCountryName = document.getElementById('gameCountryName');
        const connectionStatus = document.getElementById('connectionStatus');

        // Memory storage - ALL COUNTRIES START AT 0!
        let memoryStorage = {
            countryScores: {
                // All countries start at 0 for fair competition
            },
            personalStats: {
                // Track individual contributions
            }
        };

        function saveToMemory(key, data) {
            memoryStorage[key] = data;
        }

        function getFromMemory(key, defaultValue = null) {
            return memoryStorage[key] || defaultValue;
        }

        // Country Detection
        async function detectCountry() {
            try {
                // Try multiple IP geolocation services
                const services = [
                    'https://ipapi.co/json/',
                    'https://api.ipify.org?format=json',
                    'https://ipinfo.io/json'
                ];

                for (let service of services) {
                    try {
                        const response = await fetch(service);
                        const data = await response.json();
                        
                        let countryCode = data.country_code || data.country || 'XX';
                        if (countryCode && countryCode.length === 2) {
                            return countryCode.toUpperCase();
                        }
                    } catch (e) {
                        console.warn('Service failed:', service, e);
                        continue;
                    }
                }
                
                // Fallback: try to detect from timezone
                const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                if (timezone.includes('Bangkok') || timezone.includes('Asia/Bangkok')) {
                    return 'TH';
                } else if (timezone.includes('New_York') || timezone.includes('Los_Angeles')) {
                    return 'US';
                } else if (timezone.includes('London')) {
                    return 'GB';
                } else if (timezone.includes('Tokyo')) {
                    return 'JP';
                } else if (timezone.includes('Seoul')) {
                    return 'KR';
                }
                
                return 'XX';
            } catch (error) {
                console.error('Country detection failed:', error);
                return 'XX';
            }
        }

        // Update country display
        function updateCountryDisplay(countryCode) {
            const country = countryData[countryCode] || countryData['XX'];
            countryFlag.textContent = country.flag;
            countryName.textContent = country.name;
            gameCountryName.textContent = country.name;
        }

        // Connection status
        function updateConnectionStatus(online) {
            gameState.isOnline = online;
            connectionStatus.className = `connection-status ${online ? 'online' : 'offline'}`;
            connectionStatus.textContent = online ? 'üü¢ Online' : 'üî¥ Offline';
        }

        // Mock server functions (using memory storage)
        async function updateCountryScore(countryCode, increment = 1) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    const scores = getFromMemory('countryScores', {});
                    // Initialize country score to 0 if it doesn't exist
                    if (!(countryCode in scores)) {
                        scores[countryCode] = 0;
                    }
                    scores[countryCode] += increment;
                    saveToMemory('countryScores', scores);
                    gameState.leaderboard = scores;
                    resolve(scores[countryCode]);
                }, Math.random() * 100 + 50);
            });
        }

        async function getLeaderboard() {
            return new Promise((resolve) => {
                setTimeout(() => {
                    const scores = getFromMemory('countryScores', {});
                    resolve(scores);
                }, Math.random() * 100 + 50);
            });
        }

        // Game Functions
        function updateScoreDisplay() {
            scoreDisplay.textContent = gameState.countryClicks.toLocaleString();
            personalClicksDisplay.textContent = gameState.personalClicks.toLocaleString();
            countryClicksDisplay.textContent = gameState.countryClicks.toLocaleString();
        }

        function updateCPS() {
            const now = Date.now();
            gameState.clickTimes = gameState.clickTimes.filter(time => now - time < 1000);
            cpsDisplay.textContent = gameState.clickTimes.length;
        }

        function createClickEffect(x, y) {
            const effect = document.createElement('div');
            effect.className = 'click-effect';
            effect.textContent = '+1';
            effect.style.left = x + 'px';
            effect.style.top = y + 'px';
            
            dinoContainer.appendChild(effect);
            
            setTimeout(() => {
                if (effect.parentNode) {
                    effect.parentNode.removeChild(effect);
                }
            }, 1000);
        }

        async function handleDinoClick(event) {
            gameState.personalClicks++;
            gameState.clickTimes.push(Date.now());
            
            // Visual feedback
            dino.classList.add('clicked');
            setTimeout(() => dino.classList.remove('clicked'), 100);
            
            // Create click effect
            const rect = dinoContainer.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            createClickEffect(x, y);
            
            // Update country score
            try {
                gameState.countryClicks = await updateCountryScore(gameState.userCountry, 1);
                updateConnectionStatus(true);
            } catch (error) {
                console.error('Failed to update score:', error);
                updateConnectionStatus(false);
                gameState.countryClicks++;
            }
            
            updateScoreDisplay();
            updateCPS();
            
            // Save personal progress
            saveToMemory('personalClicks_' + gameState.userCountry, gameState.personalClicks);
        }

        // Leaderboard
        async function loadLeaderboard() {
            try {
                const scores = await getLeaderboard();
                displayLeaderboard(scores);
                updateConnectionStatus(true);
            } catch (error) {
                console.error('Failed to load leaderboard:', error);
                updateConnectionStatus(false);
                displayLeaderboard(gameState.leaderboard);
            }
        }

        function displayLeaderboard(scores) {
            const sortedCountries = Object.entries(scores)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 15);
            
            leaderboardList.innerHTML = '';
            
            if (sortedCountries.length === 0) {
                leaderboardList.innerHTML = `
                    <div class="loading">
                        <div style="color: #FFD700; font-size: 1.2rem; margin-bottom: 10px;">üèÅ Battle Just Started!</div>
                        <div>Be the first to click and put your country on the leaderboard!</div>
                    </div>
                `;
                return;
            }
            
            sortedCountries.forEach(([countryCode, score], index) => {
                const country = countryData[countryCode] || countryData['XX'];
                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                
                if (countryCode === gameState.userCountry) {
                    item.classList.add('current-country');
                }
                
                const rank = index + 1;
                let rankClass = '';
                if (rank === 1) rankClass = 'first';
                else if (rank === 2) rankClass = 'second';
                else if (rank === 3) rankClass = 'third';
                
                item.innerHTML = `
                    <div class="rank ${rankClass}">#${rank}</div>
                    <div class="country-info-item">
                        <div class="country-flag-small">${country.flag}</div>
                        <div class="country-name-small">${country.name}</div>
                    </div>
                    <div class="country-score-small">${score.toLocaleString()}</div>
                `;
                
                leaderboardList.appendChild(item);
            });
        }

        // Event Listeners
        dino.addEventListener('click', handleDinoClick);

        // Prevent right-click context menu on dino
        dino.addEventListener('contextmenu', (e) => e.preventDefault());

        // Keyboard support
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' || e.code === 'Enter') {
                e.preventDefault();
                const event = new MouseEvent('click', {
                    clientX: dinoContainer.offsetLeft + dinoContainer.offsetWidth / 2,
                    clientY: dinoContainer.offsetTop + dinoContainer.offsetHeight / 2
                });
                handleDinoClick(event);
            }
        });

        // Initialize game
        async function initializeGame() {
            // Detect country first
            updateConnectionStatus(false);
            connectionStatus.textContent = 'üîÑ Detecting country...';
            
            gameState.userCountry = await detectCountry();
            updateCountryDisplay(gameState.userCountry);
            
            // Load existing personal clicks for this country
            gameState.personalClicks = getFromMemory('personalClicks_' + gameState.userCountry, 0);
            
            // Initialize country score to 0 if it doesn't exist
            const scores = getFromMemory('countryScores', {});
            if (!(gameState.userCountry in scores)) {
                scores[gameState.userCountry] = 0;
                saveToMemory('countryScores', scores);
            }
            gameState.countryClicks = scores[gameState.userCountry];
            
            updateConnectionStatus(true);
            updateScoreDisplay();
            loadLeaderboard();
        }

        // Periodic updates to simulate live competition
        setInterval(() => {
            updateCPS();
            loadLeaderboard();
            
            // Simulate other countries clicking occasionally (for demo purposes)
            const scores = getFromMemory('countryScores', {});
            const allCountries = Object.keys(countryData);
            
            // Randomly add activity from other countries
            if (Math.random() < 0.15) { // 15% chance every 3 seconds
                const randomCountry = allCountries[Math.floor(Math.random() * allCountries.length)];
                if (randomCountry !== gameState.userCountry && randomCountry !== 'XX') {
                    if (!(randomCountry in scores)) {
                        scores[randomCountry] = 0;
                    }
                    scores[randomCountry] += Math.floor(Math.random() * 2) + 1; // Add 1-2 points
                    saveToMemory('countryScores', scores);
                }
            }
        }, 3000);

        // Initialize
        initializeGame();
    </script>
</body>
</html>